# NuDesk 업무 프로세스 가이드 (Development Workflow)

이 문서는 티켓의 **상태(Status)**와 유저의 **역할(Role)**에 따른 상세 개발 프로세스 및 비즈니스 로직을 정의합니다.

## 1. 업무 라이프사이클 개요 (Life-cycle Overview)

업무는 크게 `등록 ➔ 접수 ➔ 착수 ➔ 진행 ➔ 완료`의 단계를 거치며, 각 단계마다 역할별 권한과 UI가 동적으로 변화합니다.

---

## 2. 단계별 상세 프로세스

### **단계 1: 업무 등록 (Registration)**
*   **CUSTOMER (고객)**
    *   **액션**: 신규 티켓 등록 (희망 종료일 필수 지정).
    *   **결과**: 상태는 **`WAITING` (대기)**로 생성되며, 입력한 날짜는 `initial_end_date`에 저장됩니다.
*   **ADMIN / STAFF (운영진)**
    *   **액션**: 운영진 직접 등록 (인력 배치 및 확정 종료일 지정).
    *   **결과**: 상태는 즉시 **`ACCEPTED` (접수)**로 생성됩니다. `initial_end_date`와 `end_date`가 동일하게 저장됩니다.

### **단계 2: 업무 확인 및 접수 (Triage)**
*   **ADMIN / STAFF 액션**: `WAITING` 상태의 티켓 상세 페이지에 진입.
*   **시스템 로직**: 진입과 동시에 상태를 **`ACCEPTED` (접수)**로 자동 변경합니다.
*   **UI 변화**: 운영진에게는 우측에 '업무 시작 메시지 작성' 폼이 나타납니다.

### **단계 3: 실무 착수 (Start Work)**
*   **ADMIN / STAFF 액션**: 담당 인력 최종 확인, 종료일 최종 확정 후 업무 시작 메시지 전송.
    *   **종료일 변경 제한**: 최초 희망일(`initial_end_date`)이 오늘이거나 이미 지난 경우, 시스템은 운영진의 날짜 변경 섹션을 자동으로 숨깁니다.
*   **시스템 로직**: 
    1.  상태를 **`IN_PROGRESS` (진행)**로 변경.
    2.  **날짜 동기화**: 운영진이 날짜를 직접 선택하지 않은 경우(섹션이 숨겨진 경우 포함), `initial_end_date`를 `confirmed_end_date` 및 시스템 종료일(`end_date`)에 자동으로 복사하여 저장합니다.
    3.  첫 메시지를 '실무 착수 메시지'로 분류하여 히스토리에 등록.
*   **UI 변화**: 고객에게도 이때부터 우측 소통 영역이 노출됩니다.

### **단계 4: 업무 수행 및 소통 (Execution)**
*   **자동 지연 모니터링**: 
    *   **확정 종료일자(confirmed_end_date)**(없으면 `initial_end_date`)가 현재 날짜(`today`)보다 지나면, 시스템은 이를 즉시 **`DELAYED`** 상태로 노출합니다.
    *   `WAITING`, `ACCEPTED`, `IN_PROGRESS` 상태인 모든 티켓에 공통 적용됩니다.
    *   이 경우 **확정 종료일자**는 **최초 종료일자**로 자동 동기화되어 저장 및 표시됩니다.
*   **공통 액션**: 댓글 및 파일 첨부를 통한 실무 커뮤니케이션.
*   **특수 상태**: 일정 조정 등이 필요할 경우 운영진이 **`REQUESTED` (요청)** 상태로 변경하여 관리할 수 있습니다.

### **단계 5: 업무 완료 (Completion)**
*   **ADMIN / STAFF 액션**: 업무 종료 처리.
*   **결과**: 상태가 **`COMPLETED` (완료)**로 변경되며, 모든 수정 및 댓글 작성이 차단됩니다.

---

## 3. 역할/상태별 UI 제어 매트릭스

| 상태 | 유저 역할 | 좌측 (정보 영역) | 우측 (소통 영역) | 특이사항 |
| :--- | :--- | :--- | :--- | :--- |
| **`WAITING`** | CUSTOMER | Full-width 노출 | **숨김** | 정보 확인만 가능 |
| | ADMIN/STAFF | 7:5 레이아웃 | **접수 폼** | 진입 시 `ACCEPTED` 전환 |
| **`ACCEPTED`** | CUSTOMER | Full-width 노출 | **숨김** | 소통 시작 전 단계 |
| | ADMIN/STAFF | 7:5 레이아웃 | **착수 메시지 폼** | 종료일/인력 최종 확정 단계 |
| **`IN_PROGRESS`** | ALL | 7:5 레이아웃 | **진행 히스토리** | 상호 자유로운 소통 |
| **`COMPLETED`** | ALL | 7:5 레이아웃 | **조회 전용** | 입력 폼 비활성화 |

---

## 4. 메시지 유형 구분 (Message Distinction)

시스템은 `chats` 테이블의 데이터를 성격에 따라 두 가지로 엄격히 구분하여 UI에 노출합니다.

### **4.1. 실무 착수 메시지 (Start-Work Message)**
*   **정의**: 운영진(ADMIN/STAFF)이 `ACCEPTED` 상태에서 실무에 착수하며 처음으로 남기는 공식 메시지.
*   **노출 위치**: 상세 페이지 **좌측 정보 영역** 하단 (업무 내용과 함께 고정 노출).
*   **특징**: 
    *   해당 업무의 공식적인 처리 가이드라인 역할을 함.
    *   우측 '진행 히스토리'에서는 중복 노출되지 않도록 제외됨.
    *   디자인: 블루 톤의 배경(`bg-blue-50/30`)과 굵은 폰트(`text-lg font-black`) 적용.

### **4.2. 댓글 및 진행 히스토리 (General Comments)**
*   **정의**: 실무 착수 메시지 이후 발생하는 모든 상호 커뮤니케이션 내역.
*   **노출 위치**: 상세 페이지 **우측 채팅 영역** (스크롤 가능한 리스트).
*   **특징**:
    *   메신저 형태의 UI 적용 (본인 우측 정렬, 타인 좌측 정렬).
    *   자유로운 의견 교환 및 추가 파일 공유 목적으로 사용.

---

## 5. 핵심 데이터 처리 규칙 (Data Rules)

1.  **날짜 보존**: `initial_end_date`는 절대 수정하지 않으며, 운영진의 변경 사항은 오직 `confirmed_end_date`에만 기록합니다.
2.  **자동화**: `WAITING`에서 `ACCEPTED`로의 전환은 상세 페이지 `useEffect` 내에서 유저 역할 체크 후 수행합니다.
3.  **파일 업로드**: 티켓 등록 시에는 `new-tickets/` 폴더에, 채팅 중 업로드는 `ticket-id/` 폴더에 구분하여 저장합니다.

---
*이 가이드는 NuDesk의 핵심 개발 프로세스를 정의하며, 모든 기능 구현은 이 흐름을 따라야 합니다.*
